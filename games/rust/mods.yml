# Rust Modding Frameworks Configuration

# Oxide Framework Configuration
oxide:
  name: Oxide
  desc: |
    Oxide is a popular modding framework for Rust that allows server administrators
    to extend server functionality with plugins. It provides a comprehensive API
    for plugin development and management.

  version: "latest"
  website: "https://umod.org"

  # Oxide kurulum dizini
  install_path: "/home/container/oxide"

  # Oxide plugin dizini
  plugins_path: "/home/container/oxide/plugins"

  # Oxide config dizini
  config_path: "/home/container/oxide/config"

  # Oxide data dizini
  data_path: "/home/container/oxide/data"

  # Oxide log dizini
  logs_path: "/home/container/oxide/logs"

  scripts:
    installer:
      code: |
        #!/bin/bash
        # Oxide Framework Installation Script
        # Server Files: /home/container

        # ANSI color codes
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        CYAN='\033[0;36m'
        WHITE='\033[1;37m'
        BOLD='\033[1m'
        NC='\033[0m' # No Color

        echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}${BOLD}║          Oxide Framework Installation Script               ║${NC}"
        echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
        echo ""

        # Oxide dizinlerini oluştur
        echo -e "${CYAN}${BOLD}[1/4]${NC} ${WHITE}Creating Oxide directories...${NC}"
        mkdir -p /mnt/server/oxide/{plugins,config,data,logs}

        if [ $? -eq 0 ]; then
          echo -e "${GREEN}✓ Oxide directories created${NC}"
        else
          echo -e "${RED}✗ Failed to create Oxide directories${NC}"
          exit 1
        fi

        # Oxide'i indir
        echo -e "${CYAN}${BOLD}[2/4]${NC} ${WHITE}Downloading Oxide framework...${NC}"
        OXIDE_URL="https://github.com/OxideMod/Oxide.Rust/releases/latest/download/Oxide.Rust-linux.zip"

        cd /tmp
        if curl -sSL -L -o oxide.zip "${OXIDE_URL}"; then
          echo -e "${GREEN}✓ Oxide downloaded successfully${NC}"
        else
          echo -e "${RED}✗ Failed to download Oxide${NC}"
          exit 1
        fi

        # Oxide'i çıkar
        echo -e "${CYAN}${BOLD}[3/4]${NC} ${WHITE}Extracting Oxide framework...${NC}"
        if unzip -q oxide.zip -d /mnt/server/ 2>/dev/null; then
          echo -e "${GREEN}✓ Oxide extracted successfully${NC}"
        else
          echo -e "${RED}✗ Failed to extract Oxide${NC}"
          exit 1
        fi

        # İzinleri ayarla
        echo -e "${CYAN}${BOLD}[4/4]${NC} ${WHITE}Setting permissions...${NC}"
        chmod -R 755 /mnt/server/oxide
        echo -e "${GREEN}✓ Permissions configured${NC}"

        echo ""
        echo -e "${GREEN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}${BOLD}║     ✓ Oxide Framework Installation Completed!             ║${NC}"
        echo -e "${GREEN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
        echo ""
      image: ghcr.io/rustopic/installers:debian
      entry: bash
    
    entry:
      code: |
        #!/bin/bash
        # Oxide Framework Entry Script
        # Server Files: /home/container

        # ANSI color codes
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        CYAN='\033[0;36m'
        WHITE='\033[1;37m'
        BOLD='\033[1m'
        NC='\033[0m' # No Color

        # Make internal Docker IP address available to processes.
        export INTERNAL_IP=`ip route get 1 | awk '{print $(NF-2);exit}'`

        ## if auto_update is not set or to 1 update
        if [ -z ${AUTO_UPDATE} ] || [ "${AUTO_UPDATE}" == "1" ]; then
          # Branch sistemi: staging, aux01, aux02, aux03 için -beta parametresi eklenir
          # Branch null/boş ise normal public branch kullanılır
          STEAMCMD_UPDATE_CMD="+app_update 258550"
          
          if [ -n "${BRANCH}" ]; then
            case "${BRANCH}" in
              staging|aux01|aux02|aux03)
                STEAMCMD_UPDATE_CMD="${STEAMCMD_UPDATE_CMD} -beta ${BRANCH}"
                echo -e "${CYAN}ℹ️  Using beta branch: ${WHITE}${BOLD}${BRANCH}${NC}"
                ;;
              *)
                echo -e "${YELLOW}⚠️  Warning: Unknown branch '${BRANCH}', using default public branch${NC}"
                ;;
            esac
          fi
          
          echo -e "${CYAN}${BOLD}[Update]${NC} ${WHITE}Updating Rust server...${NC}"
          ./steamcmd/steamcmd.sh +force_install_dir /home/container +login anonymous ${STEAMCMD_UPDATE_CMD} +quit
          if [ $? -eq 0 ]; then
            echo -e "${GREEN}✓ Rust server updated successfully${NC}"
          else
            echo -e "${RED}✗ Failed to update Rust server${NC}"
          fi
        else
          echo -e "${YELLOW}ℹ️  Not updating game server as auto update was set to 0. Starting Server${NC}"
        fi

        # Replace Startup Variables
        MODIFIED_STARTUP=`eval echo $(echo ${STARTUP} | sed -e 's/{{/${/g' -e 's/}}/}/g')`
        echo -e "${CYAN}:/home/container$ ${WHITE}${MODIFIED_STARTUP}${NC}"

        # Oxide: https://github.com/OxideMod/Oxide.Rust
        echo -e "${CYAN}${BOLD}[Oxide]${NC} ${WHITE}Updating Oxide framework...${NC}"
        curl -sSL "https://github.com/OxideMod/Oxide.Rust/releases/latest/download/Oxide.Rust-linux.zip" > umod.zip
        unzip -o -q umod.zip
        rm umod.zip
        if [ $? -eq 0 ]; then
          echo -e "${GREEN}✓ Oxide framework updated successfully${NC}"
        else
          echo -e "${RED}✗ Failed to update Oxide framework${NC}"
        fi

        # Fix for Rust not starting
        export LD_LIBRARY_PATH=$(pwd)/RustDedicated_Data/Plugins/x86_64:$(pwd)

        # Run the Server
        node /wrapper.js "${MODIFIED_STARTUP}"
      image: ghcr.io/rustopic/games:rust
      entry: bash

  config:
    # Oxide config dosyası
    main_config: "oxide/config.json"

    # Oxide startup komutu
    startup_args: ""

    # Oxide reload komutu
    reload_command: "oxide.reload *"

    # Oxide unload komutu
    unload_command: "oxide.unload *"

  variables: []

# Carbon Framework Configuration
carbon:
  name: Carbon
  desc: |
    Carbon is a modern, high-performance modding framework for Rust that aims to be
    a faster and more efficient alternative to Oxide. It provides better performance
    and improved plugin compatibility while maintaining a similar API structure.

  version: "latest"
  website: "https://codefling.com/carbon"

  # Carbon kurulum dizini
  install_path: "/mnt/server/carbon"

  # Carbon plugin dizini
  plugins_path: "/mnt/server/carbon/plugins"

  # Carbon config dizini
  config_path: "/mnt/server/carbon/config"

  # Carbon data dizini
  data_path: "/mnt/server/carbon/data"

  # Carbon log dizini
  logs_path: "/mnt/server/carbon/logs"

  # Carbon ana dosyası
  core_file: "Carbon.dll"

  scripts:
    installer:
      code: |
        #!/bin/bash
        # Carbon Framework Installation Script
        # Server Files: /mnt/server

        # ANSI color codes
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        CYAN='\033[0;36m'
        WHITE='\033[1;37m'
        BOLD='\033[1m'
        NC='\033[0m' # No Color

        echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}${BOLD}║          Carbon Framework Installation Script              ║${NC}"
        echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
        echo ""

        # Carbon dizinlerini oluştur
        echo -e "${CYAN}${BOLD}[1/4]${NC} ${WHITE}Creating Carbon directories...${NC}"
        mkdir -p /mnt/server/carbon/{plugins,config,data,logs}

        if [ $? -eq 0 ]; then
          echo -e "${GREEN}✓ Carbon directories created${NC}"
        else
          echo -e "${RED}✗ Failed to create Carbon directories${NC}"
          exit 1
        fi

        # Carbon'i indir
        echo -e "${CYAN}${BOLD}[2/4]${NC} ${WHITE}Downloading Carbon framework...${NC}"
        CARBON_URL="https://github.com/CarbonCommunity/Carbon.Core/releases/latest/download/Carbon.Linux.zip"

        cd /tmp
        if curl -sSL -L -o carbon.zip "${CARBON_URL}"; then
          echo -e "${GREEN}✓ Carbon downloaded successfully${NC}"
        else
          echo -e "${RED}✗ Failed to download Carbon${NC}"
          exit 1
        fi

        # Carbon'i çıkar
        echo -e "${CYAN}${BOLD}[3/4]${NC} ${WHITE}Extracting Carbon framework...${NC}"
        if unzip -q carbon.zip -d /mnt/server/ 2>/dev/null; then
          echo -e "${GREEN}✓ Carbon extracted successfully${NC}"
        else
          echo -e "${RED}✗ Failed to extract Carbon${NC}"
          exit 1
        fi

        # İzinleri ayarla
        echo -e "${CYAN}${BOLD}[4/4]${NC} ${WHITE}Setting permissions...${NC}"
        chmod -R 755 /mnt/server/carbon
        echo -e "${GREEN}✓ Permissions configured${NC}"

        echo ""
        echo -e "${GREEN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}${BOLD}║     ✓ Carbon Framework Installation Completed!            ║${NC}"
        echo -e "${GREEN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
        echo ""
      image: ghcr.io/rustopic/installers:debian
      entry: bash
    
    entry:
      code: |
        #!/bin/bash
        # Carbon Framework Entry Script
        # Server Files: /home/container

        # ANSI color codes
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        CYAN='\033[0;36m'
        WHITE='\033[1;37m'
        BOLD='\033[1m'
        NC='\033[0m' # No Color

        # Make internal Docker IP address available to processes.
        export INTERNAL_IP=`ip route get 1 | awk '{print $(NF-2);exit}'`

        ## if auto_update is not set or to 1 update
        if [ -z ${AUTO_UPDATE} ] || [ "${AUTO_UPDATE}" == "1" ]; then
          # Branch sistemi: staging, aux01, aux02, aux03 için -beta parametresi eklenir
          # Branch null/boş ise normal public branch kullanılır
          STEAMCMD_UPDATE_CMD="+app_update 258550"
          
          if [ -n "${BRANCH}" ]; then
            case "${BRANCH}" in
              staging|aux01|aux02|aux03)
                STEAMCMD_UPDATE_CMD="${STEAMCMD_UPDATE_CMD} -beta ${BRANCH}"
                echo -e "${CYAN}ℹ️  Using beta branch: ${WHITE}${BOLD}${BRANCH}${NC}"
                ;;
              *)
                echo -e "${YELLOW}⚠️  Warning: Unknown branch '${BRANCH}', using default public branch${NC}"
                ;;
            esac
          fi
          
          echo -e "${CYAN}${BOLD}[Update]${NC} ${WHITE}Updating Rust server...${NC}"
          ./steamcmd/steamcmd.sh +force_install_dir /home/container +login anonymous ${STEAMCMD_UPDATE_CMD} +quit
          if [ $? -eq 0 ]; then
            echo -e "${GREEN}✓ Rust server updated successfully${NC}"
          else
            echo -e "${RED}✗ Failed to update Rust server${NC}"
          fi
        else
          echo -e "${YELLOW}ℹ️  Not updating game server as auto update was set to 0. Starting Server${NC}"
        fi

        # Replace Startup Variables
        MODIFIED_STARTUP=`eval echo $(echo ${STARTUP} | sed -e 's/{{/${/g' -e 's/}}/}/g')`
        echo -e "${CYAN}:/home/container$ ${WHITE}${MODIFIED_STARTUP}${NC}"

        # Carbon: https://github.com/CarbonCommunity/Carbon.Core
        echo -e "${CYAN}${BOLD}[Carbon]${NC} ${WHITE}Updating Carbon framework...${NC}"
        curl -sSL "https://github.com/CarbonCommunity/Carbon.Core/releases/download/production_build/Carbon.Linux.Release.tar.gz" | tar zx
        if [ $? -eq 0 ]; then
          echo -e "${GREEN}✓ Carbon framework updated successfully${NC}"
        else
          echo -e "${RED}✗ Failed to update Carbon framework${NC}"
        fi

        export DOORSTOP_ENABLED=1
        export DOORSTOP_TARGET_ASSEMBLY="$(pwd)/carbon/managed/Carbon.Preloader.dll"
        MODIFIED_STARTUP="LD_PRELOAD=$(pwd)/libdoorstop.so ${MODIFIED_STARTUP}"

        # Fix for Rust not starting
        export LD_LIBRARY_PATH=$(pwd)/RustDedicated_Data/Plugins/x86_64:$(pwd)

        # Run the Server
        node /wrapper.js "${MODIFIED_STARTUP}"
      image: ghcr.io/rustopic/games:rust
      entry: bash

  config:
    # Carbon config dosyası
    main_config: "carbon/config.json"

    # Carbon startup komutu
    startup_args: ""

    # Carbon reload komutu
    reload_command: "carbon.reload *"

    # Carbon unload komutu
    unload_command: "carbon.unload *"

  variables: []
