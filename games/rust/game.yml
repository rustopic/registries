# Rust Game Definition
# Defines the Rust game server configuration and capabilities

id: rust
name: Rust
version: "1.0.0"
description: |
  The only aim in Rust is to survive. To do this you will need to overcome struggles
  such as hunger, thirst and cold. Build a fire. Build a shelter. Kill animals for meat.
  Protect yourself from other players, and kill them for meat. Create alliances with
  other players and form a town. Do whatever it takes to survive.

# Docker image configuration
image:
  repository: ghcr.io/rustopic/games
  tag: rust
  pullPolicy: Always

# Installation script configuration
installation:
  container: ghcr.io/rustopic/installers:debian
  entrypoint: bash
  script: |
    #!/bin/bash
    # steamcmd Base Installation Script
    # Server Files: /mnt/server
    
    # ANSI color codes
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    MAGENTA='\033[0;35m'
    CYAN='\033[0;36m'
    WHITE='\033[1;37m'
    BOLD='\033[1m'
    NC='\033[0m' # No Color
    
    SRCDS_APPID=258550
    
    echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}${BOLD}║          Rust Server Installation Script                 ║${NC}"
    echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    ## just in case someone removed the defaults.
    if [ "${STEAM_USER}" == "" ]; then
      echo -e "${YELLOW}⚠️  Steam user is not set.${NC}"
      echo -e "${BLUE}ℹ️  Using anonymous user for installation.${NC}"
      echo ""
      STEAM_USER=anonymous
      STEAM_PASS=""
      STEAM_AUTH=""
    else
      echo -e "${GREEN}✓ Steam user set to: ${WHITE}${BOLD}${STEAM_USER}${NC}"
      echo ""
    fi
    
    ## download and install steamcmd
    echo -e "${CYAN}${BOLD}[1/4]${NC} ${WHITE}Downloading SteamCMD...${NC}"
    cd /tmp
    mkdir -p /mnt/server/steamcmd
    
    if curl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz; then
      echo -e "${GREEN}✓ SteamCMD downloaded successfully${NC}"
    else
      echo -e "${RED}✗ Failed to download SteamCMD${NC}"
      exit 1
    fi
    
    echo -e "${CYAN}${BOLD}[2/4]${NC} ${WHITE}Extracting SteamCMD...${NC}"
    if tar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd > /dev/null 2>&1; then
      echo -e "${GREEN}✓ SteamCMD extracted successfully${NC}"
    else
      echo -e "${RED}✗ Failed to extract SteamCMD${NC}"
      exit 1
    fi
    
    mkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing
    cd /mnt/server/steamcmd
    
    # SteamCMD fails otherwise for some reason, even running as root.
    # This is changed at the end of the install process anyways.
    echo -e "${CYAN}${BOLD}[3/4]${NC} ${WHITE}Setting up permissions...${NC}"
    chown -R root:root /mnt
    export HOME=/mnt/server
    echo -e "${GREEN}✓ Permissions configured${NC}"
    echo ""
    
    ## install game using steamcmd
    echo -e "${CYAN}${BOLD}[4/4]${NC} ${WHITE}Installing Rust server files...${NC}"
    
    # Add beta branch if specified
    BRANCH_ARG=""
    if [ -n "${BRANCH}" ]; then
      echo -e "${MAGENTA}ℹ️  Using beta branch: ${WHITE}${BOLD}${BRANCH}${NC}"
      BRANCH_ARG="-beta ${BRANCH}"
    else
      echo -e "${BLUE}ℹ️  Installing stable release${NC}"
    fi
    
    echo -e "${YELLOW}⏳ This may take several minutes depending on your connection...${NC}"
    echo ""
    
    if ./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} +app_update ${SRCDS_APPID} ${BRANCH_ARG} ${EXTRA_FLAGS} validate +quit; then
      echo ""
      echo -e "${GREEN}✓ Rust server files installed successfully${NC}"
    else
      echo ""
      echo -e "${RED}✗ Failed to install Rust server files${NC}"
      exit 1
    fi
    
    echo ""
    echo -e "${CYAN}${BOLD}Setting up Steam libraries...${NC}"
    
    ## set up 32 bit libraries
    echo -e "${BLUE}→ Copying 32-bit Steam libraries...${NC}"
    mkdir -p /mnt/server/.steam/sdk32
    if cp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so > /dev/null 2>&1; then
      echo -e "${GREEN}✓ 32-bit libraries configured${NC}"
    else
      echo -e "${YELLOW}⚠️  Warning: Could not copy 32-bit libraries${NC}"
    fi
    
    ## set up 64 bit libraries
    echo -e "${BLUE}→ Copying 64-bit Steam libraries...${NC}"
    mkdir -p /mnt/server/.steam/sdk64
    if cp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so > /dev/null 2>&1; then
      echo -e "${GREEN}✓ 64-bit libraries configured${NC}"
    else
      echo -e "${YELLOW}⚠️  Warning: Could not copy 64-bit libraries${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}${BOLD}║     ✓ Rust Server Installation Completed Successfully!     ║${NC}"
    echo -e "${GREEN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""

# Startup command template
# Variables are replaced at runtime: {{SERVER_PORT}}, {{QUERY_PORT}}, {{RCON_PORT}}, etc.
startup:
  command: |
    ./RustDedicated -batchmode +server.port {{SERVER_PORT}} +server.queryport {{QUERY_PORT}} +server.identity "rustopic" +rcon.port {{RCON_PORT}} +rcon.web true +server.hostname "{{HOSTNAME}}" +server.level "{{LEVEL}}" +server.description "{{DESCRIPTION}}" +server.url "{{SERVER_URL}}" +server.headerimage "{{SERVER_IMG}}" +server.logoimage "{{SERVER_LOGO}}" +server.maxplayers {{MAX_PLAYERS}} +rcon.password "{{RCON_PASS}}" +server.saveinterval {{SAVEINTERVAL}} +app.port {{APP_PORT}} $( [ -z ${MAP_URL} ] && printf %s "+server.worldsize \"{{WORLD_SIZE}}\" +server.seed \"{{WORLD_SEED}}\"" || printf %s "+server.levelurl {{MAP_URL}}" ) {{ADDITIONAL_ARGS}}
  
  # Server startup detection
  done: "Server startup complete"

# Supported capabilities
capabilities:
  mods: true
  frameworks: true
  hotReload: true
  configFiles: true
  resourceDiscovery: true
  steamDiskSpace: true

# Default server settings
defaults:
  maxPlayers: 100
  worldSize: 3000
  saveInterval: 300
  serverPort: 28015
  queryPort: 27017
  rconPort: 28016
  appPort: 28082
  level: "Procedural Map"
  hostname: "A Rustopic Server"
  description: "Powered by Rustopic"
  serverUrl: "https://rustopic.com"

# Environment variables
# All variables from Pterodactyl Rust egg
environment:
  - name: HOSTNAME
    description: "The name of your server in the public server list."
    default: "A Rustopic Server"
    required: true
    rules: "required|string|max:60"
    fieldType: "text"
    
  - name: LEVEL
    description: "The world file for Rust to use."
    default: "Procedural Map"
    required: true
    rules: "required|string|max:20"
    fieldType: "text"
    
  - name: DESCRIPTION
    description: "The description under your server title. Commonly used for rules & info. Use \\n for newlines."
    default: "Powered by Rustopic"
    required: true
    rules: "required|string"
    fieldType: "text"
    
  - name: SERVER_URL
    description: "The URL for your server. This is what comes up when clicking the \"Visit Website\" button."
    default: "https://rustopic.com"
    required: false
    rules: "nullable|url"
    fieldType: "text"
    
  - name: WORLD_SIZE
    description: "The world size for a procedural map."
    default: "3000"
    required: true
    rules: "required|integer"
    fieldType: "text"
    
  - name: WORLD_SEED
    description: "The seed for a procedural map."
    default: ""
    required: false
    rules: "nullable|string"
    fieldType: "text"
    
  - name: MAX_PLAYERS
    description: "The maximum amount of players allowed in the server at once."
    default: "40"
    required: true
    rules: "required|integer"
    fieldType: "text"
    
  - name: SERVER_IMG
    description: "The header image for the top of your server listing."
    default: ""
    required: false
    rules: "nullable|url"
    fieldType: "text"
    
  - name: QUERY_PORT
    description: "Server Query Port. Can't be the same as Game's primary port."
    default: "27017"
    required: true
    rules: "required|integer"
    fieldType: "text"
    userEditable: false
    
  - name: RCON_PORT
    description: "Port for RCON connections."
    default: "28016"
    required: true
    rules: "required|integer"
    fieldType: "text"
    userEditable: false
    
  - name: RCON_PASS
    description: "RCON access password."
    default: ""
    required: true
    rules: "required|regex:/^[\\w.-]*$/|max:64"
    fieldType: "text"
    
  - name: SAVEINTERVAL
    description: "Sets the server's auto-save interval in seconds."
    default: "60"
    required: true
    rules: "required|integer"
    fieldType: "text"
    
  - name: ADDITIONAL_ARGS
    description: "Add additional startup parameters to the server."
    default: ""
    required: false
    rules: "nullable|string"
    fieldType: "text"
    
  - name: APP_PORT
    description: "Port for the Rust+ App. -1 to disable."
    default: "28082"
    required: true
    rules: "required|integer"
    fieldType: "text"
    userEditable: false
    
  - name: SERVER_LOGO
    description: "The circular server logo for the Rust+ app."
    default: ""
    required: false
    rules: "nullable|url"
    fieldType: "text"
    
  - name: MAP_URL
    description: "Overwrites the map with the one from the direct download URL. Invalid URLs will cause the server to crash."
    default: ""
    required: false
    rules: "nullable|url"
    fieldType: "text"
    
  - name: SERVER_PORT
    description: "Game server port"
    default: "28015"
    required: true
    rules: "required|integer"
    fieldType: "text"
    userEditable: false
    
  - name: BRANCH
    description: "Steam beta branch to use for server installation. Leave empty for stable release."
    default: ""
    required: false
    rules: "nullable|in:staging,aux01,aux02,aux03"
    fieldType: "select"
    options:
      - value: ""
        label: "Stable (Default)"
      - value: "staging"
        label: "Staging"
      - value: "aux01"
        label: "Auxiliary 01"
      - value: "aux02"
        label: "Auxiliary 02"
      - value: "aux03"
        label: "Auxiliary 03"

# File paths (relative to server root)
paths:
  config: "server/rustopic/cfg/server.cfg"
  identity: "server/rustopic"
  logs: "server/rustopic/logs"
  saves: "server/rustopic/saves"
  steamcmd: "steamcmd"
  steamapps: "steamapps"

# Server stop command
stop:
  command: "quit"

