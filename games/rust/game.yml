# Rust Game Definition

name: Rust
author: contact@rustopic.com
desc: |
  The only aim in Rust is to survive. To do this you will need to overcome struggles
  such as hunger, thirst and cold. Build a fire. Build a shelter. Kill animals for meat.
  Protect yourself from other players, and kill them for meat. Create alliances with
  other players and form a town. Do whatever it takes to survive.

features:
  - steam_disk_space

images:
  ghcr.io/rustopic/games:rust: ghcr.io/rustopic/games:rust

startup: "./RustDedicated -batchmode +server.port {{SERVER_PORT}} +server.queryport {{QUERY_PORT}} +server.identity \"{{IDENTITY}}\" +rcon.port {{RCON_PORT}} +rcon.web true +server.hostname \"{{HOSTNAME}}\" +server.level \"{{LEVEL}}\" +server.desc \"{{DESCRIPTION}}\" +server.url \"{{SERVER_URL}}\" +server.headerimage \"{{SERVER_IMG}}\" +server.logoimage \"{{SERVER_LOGO}}\" +server.maxplayers {{MAX_PLAYERS}} +rcon.password \"{{RCON_PASS}}\" +server.saveinterval {{SAVEINTERVAL}} +app.port {{APP_PORT}} $( [ -z ${MAP_URL} ] && printf %s \"+server.worldsize \\\"{{WORLD_SIZE}}\\\" +server.seed \\\"{{WORLD_SEED}}\\\"\" || printf %s \"+server.levelurl {{MAP_URL}}\" ) {{ADDITIONAL_ARGS}}"

config:
  files: "{}"
  startup: |
    {
      "done": "Server startup complete"
    }
  logs: "{}"
  stop: "quit"

scripts:
  installer:
    code: |
      #!/bin/bash
      # steamcmd Base Installation Script
      # Server Files: /mnt/server

      # ANSI color codes
      RED='\033[0;31m'
      GREEN='\033[0;32m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      MAGENTA='\033[0;35m'
      CYAN='\033[0;36m'
      WHITE='\033[1;37m'
      BOLD='\033[1m'
      NC='\033[0m' # No Color

      SRCDS_APPID=258550

      echo -e "${CYAN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
      echo -e "${CYAN}${BOLD}║          Rust Server Installation Script                 ║${NC}"
      echo -e "${CYAN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
      echo ""

      ## just in case someone removed the defaults.
      if [ "${STEAM_USER}" == "" ]; then
        echo -e "${YELLOW}⚠️  Steam user is not set.${NC}"
        echo -e "${BLUE}ℹ️  Using anonymous user for installation.${NC}"
        echo ""
        STEAM_USER=anonymous
        STEAM_PASS=""
        STEAM_AUTH=""
      else
        echo -e "${GREEN}✓ Steam user set to: ${WHITE}${BOLD}${STEAM_USER}${NC}"
        echo ""
      fi

      ## download and install steamcmd
      echo -e "${CYAN}${BOLD}[1/4]${NC} ${WHITE}Downloading SteamCMD...${NC}"
      cd /tmp
      mkdir -p /mnt/server/steamcmd

      if curl -sSL -o steamcmd.tar.gz https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz; then
        echo -e "${GREEN}✓ SteamCMD downloaded successfully${NC}"
      else
        echo -e "${RED}✗ Failed to download SteamCMD${NC}"
        exit 1
      fi

      echo -e "${CYAN}${BOLD}[2/4]${NC} ${WHITE}Extracting SteamCMD...${NC}"
      if tar -xzvf steamcmd.tar.gz -C /mnt/server/steamcmd > /dev/null 2>&1; then
        echo -e "${GREEN}✓ SteamCMD extracted successfully${NC}"
      else
        echo -e "${RED}✗ Failed to extract SteamCMD${NC}"
        exit 1
      fi

      mkdir -p /mnt/server/steamapps # Fix steamcmd disk write error when this folder is missing
      cd /mnt/server/steamcmd

      # SteamCMD fails otherwise for some reason, even running as root.
      # This is changed at the end of the install process anyways.
      echo -e "${CYAN}${BOLD}[3/4]${NC} ${WHITE}Setting up permissions...${NC}"
      chown -R root:root /mnt
      export HOME=/mnt/server
      echo -e "${GREEN}✓ Permissions configured${NC}"
      echo ""

      ## install game using steamcmd
      echo -e "${CYAN}${BOLD}[4/4]${NC} ${WHITE}Installing Rust server files...${NC}"

      # Add beta branch if specified
      BRANCH_ARG=""
      if [ -n "${BRANCH}" ]; then
        echo -e "${MAGENTA}ℹ️  Using beta branch: ${WHITE}${BOLD}${BRANCH}${NC}"
        BRANCH_ARG="-beta ${BRANCH}"
      else
        echo -e "${BLUE}ℹ️  Installing stable release${NC}"
      fi

      echo -e "${YELLOW}⏳ This may take several minutes depending on your connection...${NC}"
      echo ""

      if ./steamcmd.sh +force_install_dir /mnt/server +login ${STEAM_USER} ${STEAM_PASS} ${STEAM_AUTH} +app_update ${SRCDS_APPID} ${BRANCH_ARG} ${EXTRA_FLAGS} validate +quit; then
        echo ""
        echo -e "${GREEN}✓ Rust server files installed successfully${NC}"
      else
        echo ""
        echo -e "${RED}✗ Failed to install Rust server files${NC}"
        exit 1
      fi

      echo ""
      echo -e "${CYAN}${BOLD}Setting up Steam libraries...${NC}"

      ## set up 32 bit libraries
      echo -e "${BLUE}→ Copying 32-bit Steam libraries...${NC}"
      mkdir -p /mnt/server/.steam/sdk32
      if cp -v linux32/steamclient.so ../.steam/sdk32/steamclient.so > /dev/null 2>&1; then
        echo -e "${GREEN}✓ 32-bit libraries configured${NC}"
      else
        echo -e "${YELLOW}⚠️  Warning: Could not copy 32-bit libraries${NC}"
      fi

      ## set up 64 bit libraries
      echo -e "${BLUE}→ Copying 64-bit Steam libraries...${NC}"
      mkdir -p /mnt/server/.steam/sdk64
      if cp -v linux64/steamclient.so ../.steam/sdk64/steamclient.so > /dev/null 2>&1; then
        echo -e "${GREEN}✓ 64-bit libraries configured${NC}"
      else
        echo -e "${YELLOW}⚠️  Warning: Could not copy 64-bit libraries${NC}"
      fi

      echo ""
      echo -e "${GREEN}${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
      echo -e "${GREEN}${BOLD}║     ✓ Rust Server Installation Completed Successfully!     ║${NC}"
      echo -e "${GREEN}${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
      echo ""
    image: ghcr.io/rustopic/installers:debian
    entry: bash

variables:
  - name: Server Name
    desc: "The name of your server in the public server list."
    env: HOSTNAME
    def: "A Rust Server"
    rules: "required|string|max:60"

  - name: Identity
    desc: "Changes path to your server data rust/server/my_server_identity. Useful for running multiple instances."
    env: IDENTITY
    def: "rustopic"
    rules: "required|string|max:10"

  - name: Modding Framework
    desc: |
      The modding framework to be used: carbon, oxide, vanilla.
      Defaults to "vanilla" for a non-modded server installation.
    env: FRAMEWORK
    def: "vanilla"
    rules: "required|in:vanilla,oxide,carbon"

  - name: Level
    desc: "The world file for Rust to use."
    env: LEVEL
    def: "Procedural Map"
    rules: "required|string|max:20"

  - name: Description
    desc: "The desc under your server title. Commonly used for rules & info. Use \\n for newlines."
    env: DESCRIPTION
    def: "Powered by Rustopic"
    rules: "required|string"

  - name: URL
    desc: 'The URL for your server. This is what comes up when clicking the "Visit Website" button.'
    env: SERVER_URL
    def: "https://rustopic.com"
    rules: "nullable|url"

  - name: World Size
    desc: "The world size for a procedural map."
    env: WORLD_SIZE
    def: "3000"
    rules: "required|integer"

  - name: World Seed
    desc: "The seed for a procedural map."
    env: WORLD_SEED
    def: "1234"
    rules: "nullable|string"

  - name: Max Players
    desc: "The maximum amount of players allowed in the server at once."
    env: MAX_PLAYERS
    def: "200"
    rules: "required|integer"

  - name: Server Image
    desc: "The header image for the top of your server listing."
    env: SERVER_IMG
    def: ""
    rules: "nullable|url"

  - name: Query Port
    desc: "Server Query Port. Can't be the same as Game's primary port."
    env: QUERY_PORT
    def: "27017"
    rules: "required|integer"

  - name: RCON Port
    desc: "Port for RCON connections."
    env: RCON_PORT
    def: "28016"
    rules: "required|integer"

  - name: RCON Password
    desc: "RCON access password."
    env: RCON_PASS
    def: ""
    rules: "required|regex:/^[\\w.-]*$/|max:64"

  - name: Save Interval
    desc: "Sets the server's auto-save interval in seconds."
    env: SAVEINTERVAL
    def: "300"
    rules: "required|integer"

  - name: Additional Arguments
    desc: "Add additional startup parameters to the server."
    env: ADDITIONAL_ARGS
    def: ""
    rules: "nullable|string"

  - name: App Port
    desc: "Port for the Rust+ App. -1 to disable."
    env: APP_PORT
    def: "28082"
    rules: "required|integer"

  - name: Server Logo
    desc: "The circular server logo for the Rust+ app."
    env: SERVER_LOGO
    def: ""
    rules: "nullable|url"

  - name: Custom Map URL
    desc: "Overwrites the map with the one from the direct download URL. Invalid URLs will cause the server to crash."
    env: MAP_URL
    def: ""
    rules: "nullable|url"
